import{s as Os,a as ze,l as x,b as Re,m as Ne,c as Xe,t as De,d as Is,e as ks,f as Ss,q as Bs,g as Ls,h as Cs,r as kt,i as ws,j as B,k as xs,n as Ys,o as c,E as Ts,p as As,u as St,v as Bt,w as Ps,x as qs,y as Fs,z as Ms,A as Us,B as N,C as Z,D as m,F as j,G as Xs,H as Nn,I as Zs,J as zs,K as Rs,L as Ns,M as Ds,N as q,O as he}from"./index-RhTXoZal.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";import"https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";function ca(l,u,T,C){const le=Os.getActiveTab(),A=document.querySelector(`.settings-tab[data-tab="${le}"]`);A&&(document.querySelectorAll(".settings-tab").forEach(e=>e.classList.remove("active")),document.querySelectorAll(".settings-tab-content").forEach(e=>e.classList.remove("active")),A.classList.add("active"),document.getElementById(`settings-tab-${le}`)?.classList.add("active")),ze.updateUI(ze.user);const H=document.getElementById("toggle-email-auth-btn"),J=document.getElementById("cancel-email-auth-btn"),w=document.getElementById("email-auth-modal"),$=document.getElementById("auth-email"),L=document.getElementById("auth-password"),_=document.getElementById("email-signin-btn"),K=document.getElementById("email-signup-btn"),F=document.getElementById("reset-password-btn");H&&w&&H.addEventListener("click",()=>{w.classList.add("active")}),J&&w&&(J.addEventListener("click",()=>{w.classList.remove("active")}),w.querySelector(".modal-overlay").addEventListener("click",()=>{w.classList.remove("active")})),_&&_.addEventListener("click",async()=>{const e=$.value,t=L.value;if(!e||!t){alert("Please enter both email and password.");return}try{await ze.signInWithEmail(e,t),w.classList.remove("active"),$.value="",L.value=""}catch{}}),K&&K.addEventListener("click",async()=>{const e=$.value,t=L.value;if(!e||!t){alert("Please enter both email and password.");return}try{await ze.signUpWithEmail(e,t),w.classList.remove("active"),$.value="",L.value=""}catch{}}),F&&F.addEventListener("click",async()=>{const e=$.value;if(!e){alert("Please enter your email address to reset your password.");return}try{await ze.sendPasswordReset(e)}catch{}});const I=document.getElementById("lastfm-connect-btn"),y=document.getElementById("lastfm-status"),D=document.getElementById("lastfm-toggle"),M=document.getElementById("lastfm-toggle-setting"),ee=document.getElementById("lastfm-love-toggle"),ve=document.getElementById("lastfm-love-setting"),Ee=document.getElementById("lastfm-custom-creds-toggle"),d=document.getElementById("lastfm-custom-creds-toggle-setting"),v=document.getElementById("lastfm-custom-creds-setting"),O=document.getElementById("lastfm-custom-api-key"),ae=document.getElementById("lastfm-custom-api-secret"),Oe=document.getElementById("lastfm-save-custom-creds"),Lt=document.getElementById("lastfm-clear-custom-creds"),et=document.getElementById("lastfm-credential-auth"),tt=document.getElementById("lastfm-credential-form"),Ge=document.getElementById("lastfm-username"),$e=document.getElementById("lastfm-password"),be=document.getElementById("lastfm-login-credentials"),Dn=document.getElementById("lastfm-use-oauth");function me(){l.lastfm.isAuthenticated()?(y.textContent=`Connected as ${l.lastfm.username}`,I.textContent="Disconnect",I.classList.add("danger"),M.style.display="flex",ve.style.display="flex",D.checked=x.isEnabled(),ee.checked=x.shouldLoveOnLike(),d.style.display="flex",Ee.checked=x.useCustomCredentials(),nt(),Ct()):(y.textContent="Connect your Last.fm account to scrobble tracks",I.textContent="Connect Last.fm",I.classList.remove("danger"),M.style.display="none",ve.style.display="none",d.style.display="none",v.style.display="none",Ct())}function On(){et&&(et.style.display="block"),tt&&(tt.style.display="block"),Ge&&Ge.focus()}function Ct(){et&&(et.style.display="none"),tt&&(tt.style.display="none"),Ge&&(Ge.value=""),$e&&($e.value="")}function nt(){const e=x.useCustomCredentials();if(v.style.display=e?"flex":"none",e){O.value=x.getCustomApiKey(),ae.value=x.getCustomApiSecret();const t=x.getCustomApiKey()&&x.getCustomApiSecret();Lt.style.display=t?"inline-block":"none"}}me(),I?.addEventListener("click",async()=>{if(l.lastfm.isAuthenticated()){confirm("Disconnect from Last.fm?")&&(l.lastfm.disconnect(),me());return}let e=null;window.Neutralino||(e=window.open("","_blank")),I.disabled=!0,I.textContent="Opening Last.fm...";try{const{token:t,url:n}=await l.lastfm.getAuthUrl();if(window.Neutralino)try{await Neutralino.os.open(n)}catch(o){console.error("Neutralino open failed, falling back to window.open",o),e?e.location.href=n:e=window.open(n,"_blank")}else if(e)e.location.href=n;else{alert("Popup blocked! Please allow popups."),I.textContent="Connect Last.fm",I.disabled=!1;return}I.textContent="Waiting for authorization...";let s=0;const a=5,i=setInterval(async()=>{if(s++,s>a){clearInterval(i),e&&!e.closed&&e.close(),I.textContent="Connect Last.fm",I.disabled=!1,confirm("Authorization timed out. Would you like to login with username and password instead?")&&On();return}try{(await l.lastfm.completeAuthentication(t)).success&&(clearInterval(i),e&&!e.closed&&e.close(),x.setEnabled(!0),D.checked=!0,me(),I.disabled=!1)}catch{}},2e3)}catch(t){console.error("Last.fm connection failed:",t),e&&!e.closed&&e.close(),I.textContent="Connect Last.fm",I.disabled=!1,confirm("Failed to connect to Last.fm. Would you like to login with username and password instead?")&&On()}}),D&&D.addEventListener("change",e=>{x.setEnabled(e.target.checked)}),ee&&ee.addEventListener("change",e=>{x.setLoveOnLike(e.target.checked)}),Ee&&Ee.addEventListener("change",e=>{x.setUseCustomCredentials(e.target.checked),nt(),l.lastfm.reloadCredentials(),!e.target.checked&&l.lastfm.isAuthenticated()&&(l.lastfm.disconnect(),me(),alert("Switched to default API credentials. Please reconnect to Last.fm."))}),Oe&&Oe.addEventListener("click",()=>{const e=O.value.trim(),t=ae.value.trim();if(!e||!t){alert("Please enter both API Key and API Secret");return}x.setCustomApiKey(e),x.setCustomApiSecret(t),l.lastfm.reloadCredentials(),nt(),alert("Custom API credentials saved! Please reconnect to Last.fm to use them."),l.lastfm.isAuthenticated()&&(l.lastfm.disconnect(),me())}),Lt&&Lt.addEventListener("click",()=>{confirm("Clear custom API credentials?")&&(x.clearCustomCredentials(),O.value="",ae.value="",Ee.checked=!1,l.lastfm.reloadCredentials(),nt(),l.lastfm.isAuthenticated()&&(l.lastfm.disconnect(),me(),alert("Custom credentials cleared. Switched to default API credentials. Please reconnect to Last.fm.")))}),be&&be.addEventListener("click",async()=>{const e=Ge?.value?.trim(),t=$e?.value;if(!e||!t){alert("Please enter both username and password.");return}be.disabled=!0,be.textContent="Logging in...";try{(await l.lastfm.authenticateWithCredentials(e,t)).success&&(x.setEnabled(!0),D.checked=!0,me(),$e&&($e.value=""))}catch(n){console.error("Last.fm credential login failed:",n),alert("Failed to login: "+n.message)}finally{be.disabled=!1,be.textContent="Login"}}),Dn&&Dn.addEventListener("click",()=>{Ct()});const _e=document.getElementById("scrobble-percentage-slider"),Ie=document.getElementById("scrobble-percentage-input");if(_e&&Ie){const e=x.getScrobblePercentage();_e.value=e,Ie.value=e,_e.addEventListener("input",t=>{const n=parseInt(t.target.value,10);Ie.value=n,x.setScrobblePercentage(n)}),Ie.addEventListener("change",t=>{let n=parseInt(t.target.value,10);n=Math.max(1,Math.min(100,n||75)),_e.value=n,Ie.value=n,x.setScrobblePercentage(n)}),Ie.addEventListener("input",t=>{let n=parseInt(t.target.value,10);!isNaN(n)&&n>=1&&n<=100&&(_e.value=n,x.setScrobblePercentage(n))})}const st=document.getElementById("listenbrainz-enabled-toggle"),Gn=document.getElementById("listenbrainz-token-setting"),$n=document.getElementById("listenbrainz-custom-url-setting"),at=document.getElementById("listenbrainz-token-input"),ot=document.getElementById("listenbrainz-custom-url-input"),_n=()=>{const e=Re.isEnabled();st&&(st.checked=e),Gn&&(Gn.style.display=e?"flex":"none"),$n&&($n.style.display=e?"flex":"none"),at&&(at.value=Re.getToken()),ot&&(ot.value=Re.getCustomUrl())};_n(),st&&st.addEventListener("change",e=>{const t=e.target.checked;Re.setEnabled(t),_n()}),at&&at.addEventListener("change",e=>{Re.setToken(e.target.value.trim())}),ot&&ot.addEventListener("change",e=>{Re.setCustomUrl(e.target.value.trim())});const it=document.getElementById("maloja-enabled-toggle"),jn=document.getElementById("maloja-token-setting"),Qn=document.getElementById("maloja-custom-url-setting"),lt=document.getElementById("maloja-token-input"),ct=document.getElementById("maloja-custom-url-input"),Vn=()=>{const e=Ne.isEnabled();it&&(it.checked=e),jn&&(jn.style.display=e?"flex":"none"),Qn&&(Qn.style.display=e?"flex":"none"),lt&&(lt.value=Ne.getToken()),ct&&(ct.value=Ne.getCustomUrl())};Vn(),it&&it.addEventListener("change",e=>{const t=e.target.checked;Ne.setEnabled(t),Vn()}),lt&&lt.addEventListener("change",e=>{Ne.setToken(e.target.value.trim())}),ct&&ct.addEventListener("change",e=>{Ne.setCustomUrl(e.target.value.trim())});const U=document.getElementById("librefm-connect-btn"),Hn=document.getElementById("librefm-status"),dt=document.getElementById("librefm-toggle"),Jn=document.getElementById("librefm-toggle-setting"),wt=document.getElementById("librefm-love-toggle"),Kn=document.getElementById("librefm-love-setting");function xt(){l.librefm.isAuthenticated()?(Hn.textContent=`Connected as ${l.librefm.username}`,U.textContent="Disconnect",U.classList.add("danger"),Jn.style.display="flex",Kn.style.display="flex",dt.checked=Xe.isEnabled(),wt.checked=Xe.shouldLoveOnLike()):(Hn.textContent="Connect your Libre.fm account to scrobble tracks",U.textContent="Connect Libre.fm",U.classList.remove("danger"),Jn.style.display="none",Kn.style.display="none")}U&&(xt(),U.addEventListener("click",async()=>{if(l.librefm.isAuthenticated()){confirm("Disconnect from Libre.fm?")&&(l.librefm.disconnect(),xt());return}let e=null;window.Neutralino||(e=window.open("","_blank")),U.disabled=!0,U.textContent="Opening Libre.fm...";try{const{token:t,url:n}=await l.librefm.getAuthUrl();if(window.Neutralino)await Neutralino.os.open(n);else if(e)e.location.href=n;else{alert("Popup blocked! Please allow popups."),U.textContent="Connect Libre.fm",U.disabled=!1;return}U.textContent="Waiting for authorization...";let s=0;const a=30,i=setInterval(async()=>{if(s++,s>a){clearInterval(i),U.textContent="Connect Libre.fm",U.disabled=!1,e&&!e.closed&&e.close(),alert("Authorization timed out. Please try again.");return}try{const o=await l.librefm.completeAuthentication(t);o.success&&(clearInterval(i),e&&!e.closed&&e.close(),Xe.setEnabled(!0),dt.checked=!0,xt(),U.disabled=!1,alert(`Successfully connected to Libre.fm as ${o.username}!`))}catch{}},2e3)}catch(t){console.error("Libre.fm connection failed:",t),alert("Failed to connect to Libre.fm: "+t.message),U.textContent="Connect Libre.fm",U.disabled=!1,e&&!e.closed&&e.close()}}),dt&&dt.addEventListener("change",e=>{Xe.setEnabled(e.target.checked)}),wt&&wt.addEventListener("change",e=>{Xe.setLoveOnLike(e.target.checked)}));const Wn=document.getElementById("theme-picker"),Gs=De.getTheme();Wn.querySelectorAll(".theme-option").forEach(e=>{e.dataset.theme===Gs&&e.classList.add("active"),e.addEventListener("click",()=>{const t=e.dataset.theme;Wn.querySelectorAll(".theme-option").forEach(n=>n.classList.remove("active")),e.classList.add("active"),t==="custom"?(document.getElementById("custom-theme-editor").classList.add("show"),ss(),De.setTheme("custom")):(document.getElementById("custom-theme-editor").classList.remove("show"),De.setTheme(t))})});const ke=document.getElementById("applied-community-theme-container"),Yn=document.getElementById("applied-community-theme-btn"),rt=document.getElementById("community-theme-details-panel"),Xn=document.getElementById("ct-unapply-btn"),Zn=document.getElementById("applied-theme-name"),es=document.getElementById("ct-details-title"),ts=document.getElementById("ct-details-author");function ns(){const e=localStorage.getItem("community-theme");if(e)try{const t=JSON.parse(e);ke&&(ke.style.display="block"),Zn&&(Zn.textContent=t.name),es&&(es.textContent=t.name),ts&&(ts.textContent=`by ${t.author}`)}catch{ke&&(ke.style.display="none")}else ke&&(ke.style.display="none"),rt&&(rt.style.display="none")}ns(),window.addEventListener("theme-changed",ns),Yn&&Yn.addEventListener("click",()=>{const e=rt.style.display==="block";rt.style.display=e?"none":"block"}),Xn&&Xn.addEventListener("click",()=>{if(confirm("Unapply this community theme?")){localStorage.removeItem("custom_theme_css"),localStorage.removeItem("community-theme");const e=document.getElementById("custom-theme-style");e&&e.remove(),De.setTheme("system");const t=document.getElementById("theme-picker");t&&(t.querySelectorAll(".theme-option").forEach(n=>n.classList.remove("active")),t.querySelector('[data-theme="system"]')?.classList.add("active")),document.getElementById("custom-theme-editor").classList.remove("show")}});function ss(){const e=document.getElementById("theme-color-grid"),t=De.getCustomTheme()||{background:"#000000",foreground:"#fafafa",primary:"#ffffff",secondary:"#27272a",muted:"#27272a",border:"#27272a",highlight:"#ffffff"};e.innerHTML=Object.entries(t).map(([n,s])=>`
            <div class="theme-color-input">
                <label>${n}</label>
                <input type="color" data-color="${n}" value="${s}">
            </div>
        `).join("")}document.getElementById("apply-custom-theme")?.addEventListener("click",()=>{const e={};document.querySelectorAll('#theme-color-grid input[type="color"]').forEach(t=>{e[t.dataset.color]=t.value}),De.setCustomTheme(e)}),document.getElementById("reset-custom-theme")?.addEventListener("click",()=>{ss()});const Tt=document.getElementById("music-provider-setting");Tt&&(Tt.value=Is.getProvider(),Tt.addEventListener("change",e=>{Is.setProvider(e.target.value),window.location.reload()}));const At=document.getElementById("streaming-quality-setting");if(At){const e=localStorage.getItem("playback-quality")||"HI_RES_LOSSLESS";At.value=e,u.setQuality(e),At.addEventListener("change",t=>{const n=t.target.value;u.setQuality(n),localStorage.setItem("playback-quality",n)})}const Pt=document.getElementById("download-quality-setting");Pt&&(Pt.value=ks.getQuality(),Pt.addEventListener("change",e=>{ks.setQuality(e.target.value)}));const qt=document.getElementById("cover-art-size-setting");qt&&(qt.value=Ss.getSize(),qt.addEventListener("change",e=>{Ss.setSize(e.target.value)}));const Ft=document.getElementById("show-quality-badges-toggle");Ft&&(Ft.checked=Bs.isEnabled(),Ft.addEventListener("change",e=>{Bs.setEnabled(e.target.checked),window.renderQueueFunction&&window.renderQueueFunction()}));const Mt=document.getElementById("use-album-release-year-toggle");Mt&&(Mt.checked=Ls.useAlbumYear(),Mt.addEventListener("change",e=>{Ls.setUseAlbumYear(e.target.checked)}));const Ut=document.getElementById("zipped-bulk-downloads-toggle");Ut&&(Ut.checked=!Cs.shouldForceIndividual(),Ut.addEventListener("change",e=>{Cs.setForceIndividual(!e.target.checked)}));const zt=document.getElementById("replay-gain-mode");zt&&(zt.value=kt.getMode(),zt.addEventListener("change",e=>{kt.setMode(e.target.value),u.applyReplayGain()}));const Rt=document.getElementById("replay-gain-preamp");Rt&&(Rt.value=kt.getPreamp(),Rt.addEventListener("change",e=>{kt.setPreamp(parseFloat(e.target.value)||3),u.applyReplayGain()}));const Nt=document.getElementById("mono-audio-toggle");Nt&&(Nt.checked=ws.isEnabled(),Nt.addEventListener("change",e=>{const t=e.target.checked;ws.setEnabled(t),B.toggleMonoAudio(t)}));const Dt=document.getElementById("exponential-volume-toggle");Dt&&(Dt.checked=xs.isEnabled(),Dt.addEventListener("change",e=>{xs.setEnabled(e.target.checked),u.applyReplayGain()}));const mt=document.getElementById("playback-speed-slider"),ue=document.getElementById("playback-speed-input");if(mt&&ue){const e=Ys.getSpeed();mt.value=Math.max(.25,Math.min(4,e)),ue.value=e,mt.addEventListener("input",n=>{const s=parseFloat(n.target.value)||1;ue.value=s,u.setPlaybackSpeed(s)});const t=()=>{const n=parseFloat(ue.value)||1,s=Math.max(.01,Math.min(100,n));ue.value=s,s>=.25&&s<=4&&(mt.value=s),u.setPlaybackSpeed(s)};ue.addEventListener("change",t),ue.addEventListener("blur",t)}const Ot=document.getElementById("equalizer-enabled-toggle"),as=document.getElementById("equalizer-container"),p=document.getElementById("equalizer-preset-select"),os=document.getElementById("equalizer-reset-btn"),Se=document.getElementById("equalizer-bands"),ut=document.getElementById("custom-presets-optgroup"),gt=document.getElementById("custom-preset-name"),Be=document.getElementById("save-custom-preset-btn"),ft=document.getElementById("delete-custom-preset-btn"),W=document.getElementById("eq-band-count"),Le=document.getElementById("eq-range-min"),Ce=document.getElementById("eq-range-max"),je=document.getElementById("apply-eq-range-btn"),ce=document.getElementById("eq-freq-min"),de=document.getElementById("eq-freq-max"),Qe=document.getElementById("apply-eq-freq-btn"),Ve=document.getElementById("reset-eq-freq-btn"),He=document.getElementById("reset-eq-range-btn"),is=document.querySelector(".equalizer-scale"),Je=document.getElementById("eq-preamp-slider"),we=document.getElementById("eq-preamp-input"),yt=document.getElementById("eq-export-btn"),xe=document.getElementById("eq-import-btn"),Gt=document.getElementById("eq-import-file");let k=c.getBandCount(),E=c.getRange(),b=c.getFreqRange(),Ke=c.getPreamp();const $s=(e,t=b.min,n=b.max)=>{const s=[],a=Math.max(10,t),i=Math.min(96e3,n);for(let o=0;o<e;o++){const h=o/(e-1),Y=a*Math.pow(i/a,h),z=Math.round(Y);z<1e3?s.push(z.toString()):z<1e4?s.push((z/1e3).toFixed(z%1e3===0?0:1)+"K"):s.push((z/1e3).toFixed(0)+"K")}return s},te=(e,t=E.min,n=E.max,s=b.min,a=b.max)=>{if(!Se)return;const i=$s(e,s,a);Se.innerHTML="";for(let o=0;o<e;o++){const h=document.createElement("div");h.className="eq-band",h.dataset.band=o,h.innerHTML=`
                <input
                    type="range"
                    class="eq-slider"
                    min="${t}"
                    max="${n}"
                    step="0.5"
                    value="0"
                    orient="vertical"
                />
                <span class="eq-value">0</span>
                <span class="eq-freq">${i[o]}</span>
            `,Se.appendChild(h)}_s()},$t=(e,t)=>{if(!is)return;const n=is.querySelectorAll("span");n.length>=3&&(n[0].textContent=`+${t} dB`,n[1].textContent="0 dB",n[2].textContent=`${e} dB`)},We=(e,t)=>{const n=e.querySelector(".eq-value");if(!n)return;const s=t>0?`+${t}`:t.toString();n.textContent=s,n.classList.remove("positive","negative"),t>0?n.classList.add("positive"):t<0&&n.classList.add("negative")},ne=e=>{const t=Se?.querySelectorAll(".eq-band");t&&(t.forEach((n,s)=>{const a=n.querySelector(".eq-slider");a&&e[s]!==void 0&&(a.value=e[s],We(n,e[s]))}),oe())},ls=e=>{as&&(as.style.display=e?"block":"none",e&&requestAnimationFrame(oe))},_t=()=>{if(!ut)return;ut.innerHTML="";const e=c.getCustomPresets(),t=Object.keys(e);if(t.length===0){const n=document.createElement("option");n.value="",n.textContent="No custom presets saved",n.disabled=!0,ut.appendChild(n)}else t.forEach(n=>{const s=e[n],a=document.createElement("option");a.value=n,a.textContent=s.name,ut.appendChild(a)})},jt=e=>e&&e.startsWith("custom_"),Te=()=>{if(!ft||!p)return;const e=jt(p.value);ft.style.display=e?"flex":"none"},oe=()=>{const e=document.getElementById("eq-response-canvas");if(!e)return;const t=e.getContext("2d"),n=window.devicePixelRatio||1,s=e.getBoundingClientRect();if(s.width===0||s.height===0)return;e.width=s.width*n,e.height=s.height*n,t.scale(n,n);const a=s.width,i=s.height;t.clearRect(0,0,a,i);const o=Se?.querySelectorAll(".eq-band");if(!o||o.length===0)return;const h=document.createElement("div");h.style.color="rgb(var(--highlight-rgb))",document.body.appendChild(h);const Y=getComputedStyle(h).color;document.body.removeChild(h);const z=[],G=[],Q=E,r=Q.max-Q.min,g=e.getBoundingClientRect();o.forEach(f=>{const V=f.querySelector(".eq-slider"),se=V?parseFloat(V.value):0;z.push(se);const X=f.getBoundingClientRect(),re=X.left+X.width/2-g.left;G.push(re)});const ie=i,P=18,Me=ie-P,ye=P/2,R=f=>{const V=(f-Q.min)/r;return ye+(1-V)*Me},S=z.map((f,V)=>({x:G[V],y:R(f)}));if(S.length<2)return;const Ue=Y.match(/\d+/g),Et=Ue?parseInt(Ue[0]):128,bt=Ue?parseInt(Ue[1]):128,It=Ue?parseInt(Ue[2]):128,bs=f=>{const V=S[f===0?f:f-1],se=S[f],X=S[f+1],re=S[f+2]||X,pe=se.x+(X.x-V.x)/6,Js=se.y+(X.y-V.y)/6,Ks=X.x-(re.x-se.x)/6,Ws=X.y-(re.y-se.y)/6;return{cp1x:pe,cp1y:Js,cp2x:Ks,cp2y:Ws}},Rn=t.createLinearGradient(0,0,0,i);Rn.addColorStop(0,`rgba(${Et}, ${bt}, ${It}, 0.3)`),Rn.addColorStop(1,`rgba(${Et}, ${bt}, ${It}, 0.05)`),t.beginPath(),t.moveTo(S[0].x,i),t.lineTo(S[0].x,S[0].y);for(let f=0;f<S.length-1;f++){const{cp1x:V,cp1y:se,cp2x:X,cp2y:re}=bs(f),pe=S[f+1];t.bezierCurveTo(V,se,X,re,pe.x,pe.y)}t.lineTo(S[S.length-1].x,i),t.closePath(),t.fillStyle=Rn,t.fill(),t.beginPath(),t.moveTo(S[0].x,S[0].y);for(let f=0;f<S.length-1;f++){const{cp1x:V,cp1y:se,cp2x:X,cp2y:re}=bs(f),pe=S[f+1];t.bezierCurveTo(V,se,X,re,pe.x,pe.y)}t.strokeStyle=`rgb(${Et}, ${bt}, ${It})`,t.lineWidth=2,t.lineCap="round",t.lineJoin="round",t.stroke(),S.forEach(f=>{t.beginPath(),t.arc(f.x,f.y,4,0,Math.PI*2),t.fillStyle=`rgb(${Et}, ${bt}, ${It})`,t.fill(),t.beginPath(),t.arc(f.x,f.y,2,0,Math.PI*2),t.fillStyle="rgba(255, 255, 255, 0.8)",t.fill()})},_s=()=>{const e=Se?.querySelectorAll(".eq-band");if(!e||e.length===0)return;const t=c.getGains(k);let n=!1;e.forEach(s=>{const a=parseInt(s.dataset.band,10),i=s.querySelector(".eq-slider");if(i&&!isNaN(a)){const o=t[a]??0;i.value=o,We(s,o),i.addEventListener("input",h=>{const Y=parseFloat(h.target.value);if(B.setBandGain(a,Y),We(s,Y),oe(),p&&p.value!=="flat"){const z=B.getGains(),Q=Ts[p.value];Q&&Q.gains.every((r,g)=>Math.abs(r-z[g])<.01)}}),i.addEventListener("dblclick",()=>{i.value=0,B.setBandGain(a,0),We(s,0),oe()}),s.addEventListener("mousedown",h=>{h.button===0&&(n=!0,document.body.style.cursor="ns-resize",h.preventDefault())})}}),document.addEventListener("mousemove",s=>{if(!n)return;const i=document.elementFromPoint(s.clientX,s.clientY)?.closest(".eq-band");if(i){const o=i.querySelector(".eq-slider");if(o){const h=o.getBoundingClientRect(),Y=parseFloat(o.min),z=parseFloat(o.max),G=parseFloat(o.step)||.5,Q=(h.bottom-s.clientY)/h.height,r=Math.max(0,Math.min(1,Q));let g=Y+r*(z-Y);if(g=Math.round(g/G)*G,parseFloat(o.value)!==g){o.value=g;const ie=parseInt(i.dataset.band,10);B.setBandGain(ie,g),We(i,g),oe()}}}}),document.addEventListener("mouseup",()=>{n&&(n=!1,document.body.style.cursor="")}),setTimeout(()=>{oe()},100)};if(Ot){const e=c.isEnabled();Ot.checked=e,ls(e),Ot.addEventListener("change",t=>{const n=t.target.checked;B.toggleEQ(n),ls(n),n&&setTimeout(()=>{oe()},50)})}W&&(W.value=k,W.addEventListener("change",e=>{const t=parseInt(e.target.value,10);if(t>=c.MIN_BANDS&&t<=c.MAX_BANDS){k=t,c.setBandCount(t),B.setBandCount?.(t),te(t,E.min,E.max,b.min,b.max);const n=B.getGains?.()||c.getGains(t);ne(n),p&&(p.value.startsWith("custom_")||(p.value="custom")),Te();const s=W.style.backgroundColor;W.style.backgroundColor="var(--highlight)",setTimeout(()=>{W.style.backgroundColor=s},300)}})),p&&(_t(),p.value=c.getPreset(),Te(),p.addEventListener("change",e=>{const t=e.target.value;if(jt(t)){const s=c.getCustomPresets()[t];if(s&&s.gains){const a=s.bandCount||s.gains.length;a!==k&&(k=a,c.setBandCount(a),W&&(W.value=a),te(a,E.min,E.max,b.min,b.max)),B.setAllGains(s.gains),ne(s.gains),c.setPreset(t)}}else{const s=Ts[t];s&&(B.applyPreset(t),ne(s.gains))}Te()})),os&&os.addEventListener("click",()=>{B.reset(),ne(new Array(k).fill(0)),p&&(p.value="flat",Te())}),Be&&gt&&(Be.addEventListener("click",()=>{const e=gt.value.trim();if(!e){alert("Please enter a name for your preset");return}const t=B.getGains(),n=c.saveCustomPreset(e,t);if(n){_t(),p&&(p.value=n,c.setPreset(n),Te()),gt.value="";const s=Be.textContent;Be.textContent="Saved!",setTimeout(()=>{Be.textContent=s},1500)}else alert("Failed to save preset. Please try again.")}),gt.addEventListener("keypress",e=>{e.key==="Enter"&&Be.click()})),ft&&ft.addEventListener("click",()=>{if(!p)return;const e=p.value;if(!jt(e))return;const n=c.getCustomPresets()[e]?.name||"this preset";confirm(`Are you sure you want to delete "${n}"?`)&&(c.deleteCustomPreset(e)?(_t(),p.value="flat",B.reset(),ne(new Array(k).fill(0)),c.setPreset("flat"),Te()):alert("Failed to delete preset. Please try again."))}),Le&&(Le.value=E.min),Ce&&(Ce.value=E.max),$t(E.min,E.max),je&&Le&&Ce&&je.addEventListener("click",()=>{const e=parseInt(Le.value,10),t=parseInt(Ce.value,10);if(isNaN(e)||isNaN(t)){alert("Please enter valid numbers for the range");return}if(e>=0||t<=0){alert("Minimum must be negative and maximum must be positive");return}if(e<c.ABSOLUTE_MIN||t>c.ABSOLUTE_MAX){alert(`Range must be between ${c.ABSOLUTE_MIN} and ${c.ABSOLUTE_MAX} dB`);return}c.setRange(e,t),E={min:e,max:t},te(k,e,t),$t(e,t);const n=new Array(k).fill(0);B.setAllGains(n),ne(n),p&&(p.value="flat",c.setPreset("flat"));const s=je.textContent;je.textContent="Applied!",setTimeout(()=>{je.textContent=s},1500)}),He&&He.addEventListener("click",()=>{const e=c.DEFAULT_RANGE_MIN,t=c.DEFAULT_RANGE_MAX;Le&&(Le.value=e),Ce&&(Ce.value=t),c.setRange(e,t),E={min:e,max:t},te(k,e,t,b.min,b.max),$t(e,t);const n=new Array(k).fill(0);B.setAllGains(n),ne(n),p&&(p.value="flat",c.setPreset("flat"));const s=He.textContent;He.textContent="Reset!",setTimeout(()=>{He.textContent=s},1500)}),ce&&(ce.value=b.min),de&&(de.value=b.max),Qe&&ce&&de&&Qe.addEventListener("click",()=>{const e=parseInt(ce.value,10),t=parseInt(de.value,10);if(isNaN(e)||isNaN(t)){alert("Please enter valid numbers for the frequency range");return}if(e<c.ABSOLUTE_FREQ_MIN||t>c.ABSOLUTE_FREQ_MAX){alert(`Frequency range must be between ${c.ABSOLUTE_FREQ_MIN} Hz and ${c.ABSOLUTE_FREQ_MAX} Hz`);return}if(e>=t){alert("Minimum frequency must be less than maximum frequency");return}c.setFreqRange(e,t),b={min:e,max:t},B.setFreqRange(e,t),te(k,E.min,E.max,e,t);const n=new Array(k).fill(0);B.setAllGains(n),ne(n),p&&(p.value="flat",c.setPreset("flat"));const s=Qe.textContent;Qe.textContent="Applied!",setTimeout(()=>{Qe.textContent=s},1500)}),Ve&&Ve.addEventListener("click",()=>{const e=c.DEFAULT_FREQ_MIN,t=c.DEFAULT_FREQ_MAX;ce&&(ce.value=e),de&&(de.value=t),c.setFreqRange(e,t),b={min:e,max:t},B.setFreqRange(e,t),te(k,E.min,E.max,e,t);const n=new Array(k).fill(0);B.setAllGains(n),ne(n),p&&(p.value="flat",c.setPreset("flat"));const s=Ve.textContent;Ve.textContent="Reset!",setTimeout(()=>{Ve.textContent=s},1500)});const Qt=e=>{Ke=e,Je&&(Je.value=e),we&&(we.value=e),B.setPreamp?.(e)};Je&&(Je.value=Ke,Je.addEventListener("input",e=>{const t=parseFloat(e.target.value);Qt(t)})),we&&(we.value=Ke,we.addEventListener("change",e=>{let t=parseFloat(e.target.value);t=Math.max(-20,Math.min(20,t||0)),Qt(t)}),we.addEventListener("keypress",e=>{e.key==="Enter"&&e.target.blur()})),yt&&yt.addEventListener("click",()=>{const e=B.exportEQToText?.();e&&navigator.clipboard.writeText(e).then(()=>{yt.textContent="Copied!",setTimeout(()=>{yt.textContent="Export"},1500)}).catch(()=>{const t=new Blob([e],{type:"text/plain"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download="equalizer-settings.txt",document.body.appendChild(s),s.click(),document.body.removeChild(s),URL.revokeObjectURL(n)})}),xe&&Gt&&(xe.addEventListener("click",()=>{Gt.click()}),Gt.addEventListener("change",e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=s=>{const a=s.target.result;if(B.importEQFromText?.(a)){Ke=c.getPreamp(),Qt(Ke),k=c.getBandCount(),W&&(W.value=k),te(k,E.min,E.max,b.min,b.max);const o=B.getGains?.()||c.getGains(k);ne(o),xe.textContent="Imported!",setTimeout(()=>{xe.textContent="Import"},1500)}else xe.textContent="Invalid!",setTimeout(()=>{xe.textContent="Import"},1500)},n.readAsText(t),e.target.value=""})),te(k,E.min,E.max,b.min,b.max),window.addEventListener("equalizer-band-count-changed",e=>{e.detail&&e.detail.bandCount&&(k=e.detail.bandCount,W&&(W.value=k),te(k,E.min,E.max,b.min,b.max))}),window.addEventListener("equalizer-freq-range-changed",e=>{e.detail&&e.detail.min!==void 0&&e.detail.max!==void 0&&(b={min:e.detail.min,max:e.detail.max},ce&&(ce.value=b.min),de&&(de.value=b.max),te(k,E.min,E.max,b.min,b.max))}),window.addEventListener("resize",()=>{requestAnimationFrame(oe)});const cs=document.getElementById("audio-player");cs&&cs.addEventListener("loadedmetadata",()=>{setTimeout(()=>{oe()},100)});const Vt=document.getElementById("now-playing-mode");Vt&&(Vt.value=As.getMode(),Vt.addEventListener("change",e=>{As.setMode(e.target.value)}));const Ht=document.getElementById("close-modals-on-navigation-toggle");Ht&&(Ht.checked=St.shouldCloseOnNavigation(),Ht.addEventListener("change",e=>{St.setCloseOnNavigation(e.target.checked)}));const Jt=document.getElementById("intercept-back-to-close-modals-toggle");Jt&&(Jt.checked=St.shouldInterceptBackToClose(),Jt.addEventListener("change",e=>{St.setInterceptBackToClose(e.target.checked)}));const Kt=document.getElementById("compact-artist-toggle");Kt&&(Kt.checked=Bt.isCompactArtist(),Kt.addEventListener("change",e=>{Bt.setCompactArtist(e.target.checked)}));const Wt=document.getElementById("compact-album-toggle");Wt&&(Wt.checked=Bt.isCompactAlbum(),Wt.addEventListener("change",e=>{Bt.setCompactAlbum(e.target.checked)}));const Yt=document.getElementById("download-lyrics-toggle");Yt&&(Yt.checked=Ps.shouldDownloadLyrics(),Yt.addEventListener("change",e=>{Ps.setDownloadLyrics(e.target.checked)}));const Xt=document.getElementById("romaji-lyrics-toggle");Xt&&(Xt.checked=localStorage.getItem("lyricsRomajiMode")==="true",Xt.addEventListener("change",e=>{localStorage.setItem("lyricsRomajiMode",e.target.checked?"true":"false")}));const Zt=document.getElementById("album-background-toggle");Zt&&(Zt.checked=qs.isEnabled(),Zt.addEventListener("change",e=>{qs.setEnabled(e.target.checked)}));const en=document.getElementById("dynamic-color-toggle");en&&(en.checked=Fs.isEnabled(),en.addEventListener("change",e=>{Fs.setEnabled(e.target.checked),e.target.checked||window.dispatchEvent(new CustomEvent("reset-dynamic-color"))}));const tn=document.getElementById("waveform-toggle");tn&&(tn.checked=Ms.isEnabled(),tn.addEventListener("change",e=>{Ms.setEnabled(e.target.checked),window.dispatchEvent(new CustomEvent("waveform-toggle",{detail:{enabled:e.target.checked}}))}));const nn=document.getElementById("smooth-scrolling-toggle");nn&&(nn.checked=Us.isEnabled(),nn.addEventListener("change",e=>{Us.setEnabled(e.target.checked),window.dispatchEvent(new CustomEvent("smooth-scrolling-toggle",{detail:{enabled:e.target.checked}}))}));const ge=document.getElementById("visualizer-sensitivity-slider"),sn=document.getElementById("visualizer-sensitivity-value");if(ge&&sn){const e=N.getSensitivity();ge.value=e,sn.textContent=`${(e*100).toFixed(0)}%`,ge.addEventListener("input",t=>{const n=parseFloat(t.target.value);N.setSensitivity(n),sn.textContent=`${(n*100).toFixed(0)}%`})}const an=document.getElementById("smart-intensity-toggle");if(an){const e=N.isSmartIntensityEnabled();an.checked=e;const t=n=>{ge&&(ge.disabled=n,ge.parentElement.style.opacity=n?"0.5":"1",ge.parentElement.style.pointerEvents=n?"none":"auto")};t(e),an.addEventListener("change",n=>{N.setSmartIntensity(n.target.checked),t(n.target.checked)})}const Ae=document.getElementById("visualizer-enabled-toggle"),ds=document.getElementById("visualizer-mode-setting"),rs=document.getElementById("visualizer-smart-intensity-setting"),ms=document.getElementById("visualizer-sensitivity-setting"),us=document.getElementById("visualizer-preset-setting"),Pe=document.getElementById("visualizer-preset-select"),gs=document.getElementById("butterchurn-cycle-setting"),fs=document.getElementById("butterchurn-duration-setting"),ys=document.getElementById("butterchurn-randomize-setting"),ps=document.getElementById("butterchurn-specific-preset-setting"),on=document.getElementById("butterchurn-specific-preset-select"),Ye=document.getElementById("butterchurn-cycle-toggle"),ln=document.getElementById("butterchurn-duration-input"),cn=document.getElementById("butterchurn-randomize-toggle"),qe=()=>{const e=Ae?Ae.checked:!1,t=Pe?Pe.value==="butterchurn":!1,n=e&&t;gs&&(gs.style.display=n?"flex":"none"),ps&&(ps.style.display=n?"flex":"none");const s=Ye?Ye.checked:!1,a=n&&s;fs&&(fs.style.display=a?"flex":"none"),ys&&(ys.style.display=a?"flex":"none");const{keys:i}=Ds(),o=on;if(o&&i.length>0){const h=Array.from(o.options).map(G=>G.value);if(h.length===1&&h[0]===""||h.length!==i.length||!i.every(G=>h.includes(G))){const G=o.value;o.innerHTML="",i.forEach(Q=>{const r=document.createElement("option");r.value=Q,r.textContent=Q,o.appendChild(r)}),i.includes(G)?o.value=G:o.selectedIndex=0}}},hs=e=>{const t=e?"flex":"none";ds&&(ds.style.display=t),rs&&(rs.style.display=t),ms&&(ms.style.display=t),us&&(us.style.display=t),qe()};Pe&&(Pe.value=N.getPreset()),Ae&&(Ae.checked=N.isEnabled(),hs(Ae.checked),Ae.addEventListener("change",e=>{N.setEnabled(e.target.checked),hs(e.target.checked)})),Pe&&Pe.addEventListener("change",e=>{const t=e.target.value;N.setPreset(t),C&&C.visualizer&&C.visualizer.setPreset(t),qe()}),Ye&&(Ye.checked=N.isButterchurnCycleEnabled(),Ye.addEventListener("change",e=>{N.setButterchurnCycleEnabled(e.target.checked),qe()})),ln&&(ln.value=N.getButterchurnCycleDuration(),ln.addEventListener("change",e=>{let t=parseInt(e.target.value,10);(isNaN(t)||t<5)&&(t=5),t>300&&(t=300),e.target.value=t,N.setButterchurnCycleDuration(t)})),cn&&(cn.checked=N.isButterchurnRandomizeEnabled(),cn.addEventListener("change",e=>{N.setButterchurnRandomizeEnabled(e.target.checked)})),on&&on.addEventListener("change",e=>{C&&C.visualizer&&C.visualizer.presets.butterchurn&&C.visualizer.presets.butterchurn.loadPreset(e.target.value)}),window.addEventListener("butterchurn-presets-loaded",()=>{console.log("[Settings] Butterchurn presets loaded event received"),qe()});const{keys:js}=Ds();js.length>0&&(console.log("[Settings] Presets already cached, updating dropdown immediately"),qe());const dn=document.getElementById("settings-tab-audio");dn&&new MutationObserver(t=>{t.forEach(n=>{n.type==="attributes"&&n.attributeName==="class"&&dn.classList.contains("active")&&(console.log("[Settings] Audio tab became active, refreshing presets"),qe())})}).observe(dn,{attributes:!0});const rn=document.getElementById("visualizer-mode-select");rn&&(rn.value=N.getMode(),rn.addEventListener("change",e=>{N.setMode(e.target.value)}));const mn=document.getElementById("show-recommended-songs-toggle");mn&&(mn.checked=Z.shouldShowRecommendedSongs(),mn.addEventListener("change",e=>{Z.setShowRecommendedSongs(e.target.checked)}));const un=document.getElementById("show-recommended-albums-toggle");un&&(un.checked=Z.shouldShowRecommendedAlbums(),un.addEventListener("change",e=>{Z.setShowRecommendedAlbums(e.target.checked)}));const gn=document.getElementById("show-recommended-artists-toggle");gn&&(gn.checked=Z.shouldShowRecommendedArtists(),gn.addEventListener("change",e=>{Z.setShowRecommendedArtists(e.target.checked)}));const fn=document.getElementById("show-jump-back-in-toggle");fn&&(fn.checked=Z.shouldShowJumpBackIn(),fn.addEventListener("change",e=>{Z.setShowJumpBackIn(e.target.checked)}));const yn=document.getElementById("show-editors-picks-toggle");yn&&(yn.checked=Z.shouldShowEditorsPicks(),yn.addEventListener("change",e=>{Z.setShowEditorsPicks(e.target.checked)}));const pn=document.getElementById("shuffle-editors-picks-toggle");pn&&(pn.checked=Z.shouldShuffleEditorsPicks(),pn.addEventListener("change",e=>{Z.setShuffleEditorsPicks(e.target.checked)}));const pt=document.getElementById("sidebar-show-home-toggle");pt&&(pt.checked=m.shouldShowHome(),pt.addEventListener("change",e=>{m.setShowHome(e.target.checked),m.applySidebarVisibility()}));const hn=document.getElementById("sidebar-show-library-toggle");hn&&(hn.checked=m.shouldShowLibrary(),hn.addEventListener("change",e=>{m.setShowLibrary(e.target.checked),m.applySidebarVisibility()}));const vn=document.getElementById("sidebar-show-recent-toggle");vn&&(vn.checked=m.shouldShowRecent(),vn.addEventListener("change",e=>{m.setShowRecent(e.target.checked),m.applySidebarVisibility()}));const En=document.getElementById("sidebar-show-unreleased-toggle");En&&(En.checked=m.shouldShowUnreleased(),En.addEventListener("change",e=>{m.setShowUnreleased(e.target.checked),m.applySidebarVisibility()}));const bn=document.getElementById("sidebar-show-donate-toggle");bn&&(bn.checked=m.shouldShowDonate(),bn.addEventListener("change",e=>{m.setShowDonate(e.target.checked),m.applySidebarVisibility()}));const In=document.getElementById("sidebar-show-settings-toggle");In&&(In.checked=!0,In.disabled=!0,m.setShowSettings(!0));const kn=document.getElementById("sidebar-show-about-bottom-toggle");kn&&(kn.checked=m.shouldShowAbout(),kn.addEventListener("change",e=>{m.setShowAbout(e.target.checked),m.applySidebarVisibility()}));const Sn=document.getElementById("sidebar-show-download-bottom-toggle");Sn&&(Sn.checked=m.shouldShowDownload(),Sn.addEventListener("change",e=>{m.setShowDownload(e.target.checked),m.applySidebarVisibility()}));const Bn=document.getElementById("sidebar-show-discordbtn-toggle");Bn&&(Bn.checked=m.shouldShowDiscord(),Bn.addEventListener("change",e=>{m.setShowDiscord(e.target.checked),m.applySidebarVisibility()})),m.applySidebarVisibility();const fe=pt?.closest(".settings-group");if(fe){const e=r=>r?r.replace("sidebar-nav-","sidebar-show-")+"-toggle":"";m.DEFAULT_ORDER.map(r=>({sidebarId:r,toggleId:e(r)})).forEach(({toggleId:r,sidebarId:g})=>{const P=document.getElementById(r)?.closest(".setting-item");P&&(P.dataset.sidebarId=g,P.classList.add("sidebar-setting-item"),P.draggable=!0)});const n=fe.querySelector(".sidebar-settings-main"),s=fe.querySelector(".sidebar-settings-bottom"),a=()=>[...n?.querySelectorAll(".sidebar-setting-item[data-sidebar-id]")??[],...s?.querySelectorAll(".sidebar-setting-item[data-sidebar-id]")??[]];(()=>{const r=m.getOrder(),g=m.getBottomNavIds(),ie=r.filter(R=>!g.includes(R)),P=r.filter(R=>g.includes(R)),Me=a(),ye=new Map(Me.map(R=>[R.dataset.sidebarId,R]));ie.forEach(R=>{const S=ye.get(R);S&&n&&n.appendChild(S)}),P.forEach(R=>{const S=ye.get(R);S&&s&&s.appendChild(S)})})();let o=null;const h=()=>{const r=a().map(g=>g.dataset.sidebarId);m.setOrder(r),m.applySidebarVisibility()},Y=r=>{const g=r.target.closest(".sidebar-setting-item");g&&(o=g,o.classList.add("dragging"),r.dataTransfer&&(r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("text/plain",g.dataset.sidebarId||"")))},z=()=>{o&&(o.classList.remove("dragging"),o=null,h())},G=(r,g)=>r.filter(P=>P!==o).reduce((P,Me)=>{const ye=Me.getBoundingClientRect(),R=g-ye.top-ye.height/2;return R<0&&R>P.offset?{offset:R,element:Me}:P},{offset:Number.NEGATIVE_INFINITY}).element,Q=r=>{if(r.preventDefault(),!o)return;const g=o.parentElement;if(g!==n&&g!==s)return;const ie=Array.from(g.querySelectorAll(".sidebar-setting-item[data-sidebar-id]")),P=G(ie,r.clientY);P!==o&&(P?g.insertBefore(o,P):g.appendChild(o))};fe.addEventListener("dragstart",Y),fe.addEventListener("dragend",z),fe.addEventListener("dragover",Q),fe.addEventListener("drop",r=>r.preventDefault())}const Ln=document.getElementById("filename-template");Ln&&(Ln.value=localStorage.getItem("filename-template")||"{trackNumber} - {artist} - {title}",Ln.addEventListener("change",e=>{localStorage.setItem("filename-template",e.target.value)}));const Cn=document.getElementById("zip-folder-template");Cn&&(Cn.value=localStorage.getItem("zip-folder-template")||"{albumTitle} - {albumArtist}",Cn.addEventListener("change",e=>{localStorage.setItem("zip-folder-template",e.target.value)}));const wn=document.getElementById("generate-m3u-toggle");wn&&(wn.checked=j.shouldGenerateM3U(),wn.addEventListener("change",e=>{j.setGenerateM3U(e.target.checked)}));const xn=document.getElementById("generate-m3u8-toggle");xn&&(xn.checked=j.shouldGenerateM3U8(),xn.addEventListener("change",e=>{j.setGenerateM3U8(e.target.checked)}));const Tn=document.getElementById("generate-cue-toggle");Tn&&(Tn.checked=j.shouldGenerateCUE(),Tn.addEventListener("change",e=>{j.setGenerateCUE(e.target.checked)}));const An=document.getElementById("generate-nfo-toggle");An&&(An.checked=j.shouldGenerateNFO(),An.addEventListener("change",e=>{j.setGenerateNFO(e.target.checked)}));const Pn=document.getElementById("generate-json-toggle");Pn&&(Pn.checked=j.shouldGenerateJSON(),Pn.addEventListener("change",e=>{j.setGenerateJSON(e.target.checked)}));const qn=document.getElementById("relative-paths-toggle");qn&&(qn.checked=j.shouldUseRelativePaths(),qn.addEventListener("change",e=>{j.setUseRelativePaths(e.target.checked)}));const Fn=document.getElementById("separate-discs-zip-toggle");Fn&&(Fn.checked=j.shouldSeparateDiscsInZip(),Fn.addEventListener("change",e=>{j.setSeparateDiscsInZip(e.target.checked)})),document.getElementById("refresh-speed-test-btn")?.addEventListener("click",async()=>{const e=document.getElementById("refresh-speed-test-btn"),t=e.textContent;e.textContent="Testing...",e.disabled=!0;try{await T.settings.refreshInstances(),C.renderApiSettings(),e.textContent="Done!",setTimeout(()=>{e.textContent=t,e.disabled=!1},1500)}catch(n){console.error("Failed to refresh speed tests:",n),e.textContent="Error",setTimeout(()=>{e.textContent=t,e.disabled=!1},1500)}}),document.getElementById("api-instance-list")?.addEventListener("click",async e=>{const t=e.target.closest("button");if(!t)return;const n=t.closest("li"),s=parseInt(n.dataset.index,10),a=n.dataset.type||"api",i=await T.settings.getInstances(a);t.classList.contains("move-up")&&s>0?[i[s],i[s-1]]=[i[s-1],i[s]]:t.classList.contains("move-down")&&s<i.length-1&&([i[s],i[s+1]]=[i[s+1],i[s]]),T.settings.saveInstances(i,a),C.renderApiSettings()}),document.getElementById("clear-cache-btn")?.addEventListener("click",async()=>{const e=document.getElementById("clear-cache-btn"),t=e.textContent;e.textContent="Clearing...",e.disabled=!0;try{await T.clearCache(),e.textContent="Cleared!",setTimeout(()=>{e.textContent=t,e.disabled=!1,window.location.hash.includes("settings")&&C.renderApiSettings()},1500)}catch(n){console.error("Failed to clear cache:",n),e.textContent="Error",setTimeout(()=>{e.textContent=t,e.disabled=!1},1500)}}),document.getElementById("firebase-clear-cloud-btn")?.addEventListener("click",async()=>{if(confirm("Are you sure you want to delete ALL your data from the cloud? This cannot be undone."))try{await Xs.clearCloudData(),alert("Cloud data cleared successfully."),ze.signOut()}catch(e){console.error("Failed to clear cloud data:",e),alert("Failed to clear cloud data: "+e.message)}}),document.getElementById("export-library-btn")?.addEventListener("click",async()=>{const e=await Nn.exportData(),t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),n=URL.createObjectURL(t),s=document.createElement("a");s.href=n,s.download=`monochrome-library-${new Date().toISOString().split("T")[0]}.json`,s.click(),URL.revokeObjectURL(n)});const vs=document.getElementById("import-library-input");document.getElementById("import-library-btn")?.addEventListener("click",()=>{vs.click()}),vs?.addEventListener("change",async e=>{const t=e.target.files[0];if(!t)return;const n=new FileReader;n.onload=async s=>{try{const a=JSON.parse(s.target.result);await Nn.importData(a),alert("Library imported successfully!"),window.location.reload()}catch(a){console.error("Import failed:",a),alert("Failed to import library. Please check the file format.")}},n.readAsText(t)});const Mn=document.getElementById("custom-db-btn"),ht=document.getElementById("custom-db-modal"),vt=document.getElementById("custom-pb-url"),Fe=document.getElementById("custom-firebase-config"),Qs=document.getElementById("custom-db-save"),Vs=document.getElementById("custom-db-reset"),Hs=document.getElementById("custom-db-cancel");if(Mn&&ht){const e=!!window.__FIREBASE_CONFIG__,t=!!window.__POCKETBASE_URL__;if(e&&t){const s=Mn.closest(".setting-item");s&&(s.style.display="none")}t&&vt&&(vt.closest("div[style]").style.display="none"),e&&Fe&&(Fe.closest("div[style]").style.display="none"),Mn.addEventListener("click",()=>{const s=localStorage.getItem("monochrome-pocketbase-url")||"",a=localStorage.getItem("monochrome-firebase-config");if(t||(vt.value=s),!e)if(a)try{Fe.value=JSON.stringify(JSON.parse(a),null,2)}catch{Fe.value=a}else Fe.value="";ht.classList.add("active")});const n=()=>{ht.classList.remove("active")};Hs.addEventListener("click",n),ht.querySelector(".modal-overlay").addEventListener("click",n),Qs.addEventListener("click",()=>{const s=vt.value.trim(),a=Fe.value.trim();if(s?localStorage.setItem("monochrome-pocketbase-url",s):localStorage.removeItem("monochrome-pocketbase-url"),a)try{const i=JSON.parse(a);Zs(i)}catch{alert("Invalid JSON for Firebase Config");return}else zs();alert("Settings saved. Reloading..."),window.location.reload()}),Vs.addEventListener("click",()=>{confirm("Reset custom database settings to default?")&&(localStorage.removeItem("monochrome-pocketbase-url"),zs(),alert("Settings reset. Reloading..."),window.location.reload())})}const Un=document.getElementById("pwa-auto-update-toggle");Un&&(Un.checked=Rs.isAutoUpdateEnabled(),Un.addEventListener("change",e=>{Rs.setAutoUpdateEnabled(e.target.checked)}));const zn=document.getElementById("analytics-toggle");zn&&(zn.checked=Ns.isEnabled(),zn.addEventListener("change",e=>{Ns.setEnabled(e.target.checked)}));const Es=document.getElementById("reset-local-data-btn");Es&&Es.addEventListener("click",async()=>{if(confirm(`WARNING: This will clear all local data including settings, cache, and library.

Are you sure you want to continue?

(Cloud-synced data will not be affected)`))try{const e=[];Object.keys(localStorage).forEach(n=>{e.includes(n)||localStorage.removeItem(n)});try{const n=["tracks","albums","artists","playlists","settings","history"];for(const s of n)try{await Nn.performTransaction(s,"readwrite",a=>a.clear())}catch{}}catch(n){console.log("Could not clear IndexedDB stores:",n);try{const s=indexedDB.deleteDatabase("monochromeDB");await new Promise((a,i)=>{s.onsuccess=a,s.onerror=i})}catch(s){console.log("Could not delete IndexedDB:",s)}}alert("All local data has been cleared. The app will now reload."),window.location.reload()}catch(e){console.error("Failed to reset local data:",e),alert("Failed to reset local data: "+e.message)}}),ea(),ta(),sa()}function ea(){const l=document.getElementById("font-type-select"),u=document.getElementById("font-preset-section"),T=document.getElementById("font-google-section"),C=document.getElementById("font-url-section"),le=document.getElementById("font-upload-section"),A=document.getElementById("font-preset-select"),H=document.getElementById("font-google-input"),J=document.getElementById("font-google-apply"),w=document.getElementById("font-url-input"),$=document.getElementById("font-url-name"),L=document.getElementById("font-url-apply"),_=document.getElementById("font-upload-input"),K=document.getElementById("uploaded-fonts-list");if(!l)return;const F=q.getConfig();function I(d){u.style.display=d==="preset"?"block":"none",T.style.display=d==="google"?"flex":"none",C.style.display=d==="url"?"flex":"none",le.style.display=d==="upload"?"block":"none"}l.value=F.type,I(F.type),F.type==="preset"?A.value=F.family:F.type==="google"?H.value=F.family||"":F.type==="url"&&(w.value=F.url||"",$.value=F.family||""),l.addEventListener("change",d=>{I(d.target.value)}),A.addEventListener("change",d=>{const v=d.target.value;v==="System UI"?q.loadPresetFont("system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue'","sans-serif"):v==="monospace"?q.loadPresetFont("monospace","monospace"):v==="Apple Music"?q.loadAppleMusicFont():q.loadPresetFont(v,"sans-serif")}),J.addEventListener("click",()=>{const d=H.value.trim();if(!d)return;let v=d;try{if(new URL(d).hostname==="fonts.google.com"){const ae=q.parseGoogleFontsUrl(d);ae&&(v=ae)}}catch{}q.loadGoogleFont(v)}),L.addEventListener("click",()=>{const d=w.value.trim(),v=$.value.trim();d&&q.loadFontFromUrl(d,v||"CustomFont")}),_.addEventListener("change",async d=>{const v=d.target.files[0];if(v)try{const O=await q.saveUploadedFont(v);await q.loadUploadedFont(O.id),y(),_.value=""}catch(O){console.error("Failed to upload font:",O),alert("Failed to upload font")}});function y(){const d=q.getUploadedFontList();K.innerHTML="",d.forEach(v=>{const O=document.createElement("div");O.className="uploaded-font-item",O.innerHTML=`
                <span class="font-name">${v.name}</span>
                <div class="font-actions">
                    <button class="btn-icon" data-id="${v.id}" data-action="use">Use</button>
                    <button class="btn-icon btn-delete" data-id="${v.id}" data-action="delete">Delete</button>
                </div>
            `,K.appendChild(O)}),K.querySelectorAll(".btn-icon").forEach(v=>{v.addEventListener("click",async O=>{const ae=O.target.dataset.id,Oe=O.target.dataset.action;Oe==="use"?(await q.loadUploadedFont(ae),l.value="upload",I("upload")):Oe==="delete"&&confirm("Delete this font?")&&(q.deleteUploadedFont(ae),y())})})}y();const D=document.getElementById("font-size-slider"),M=document.getElementById("font-size-input"),ee=document.getElementById("font-size-reset"),ve=d=>{const v=Math.max(50,Math.min(200,parseInt(d,10)||100));return D&&(D.value=v),M&&(M.value=v),v},Ee=q.getFontSize();ve(Ee),D&&D.addEventListener("input",()=>{const d=parseInt(D.value,10);M&&(M.value=d),q.setFontSize(d)}),M&&(M.addEventListener("change",()=>{let d=parseInt(M.value,10);d=Math.max(50,Math.min(200,d||100)),ve(d),q.setFontSize(d)}),M.addEventListener("input",()=>{let d=parseInt(M.value,10);!isNaN(d)&&d>=50&&d<=200&&(D&&(D.value=d),q.setFontSize(d))})),ee&&ee.addEventListener("click",()=>{const d=q.resetFontSize();ve(d)})}function ta(){const l=document.getElementById("settings-search-input");if(!l)return;const u=l.parentElement.querySelector(".search-clear-btn");u&&u.addEventListener("click",()=>{l.value="",l.dispatchEvent(new Event("input")),l.focus()});const T=()=>{u&&(u.style.display=l.value?"flex":"none")};l.addEventListener("input",()=>{T(),na(l.value.toLowerCase().trim())}),l.addEventListener("focus",T)}function na(l){const u=document.getElementById("page-settings");if(!u)return;const T=u.querySelectorAll(".settings-tab-content"),C=u.querySelectorAll(".settings-tab");if(!l){T.forEach(L=>{L.classList.remove("active")}),C.forEach(L=>{L.classList.remove("active")});const A=Os.getActiveTab(),H=document.querySelector(`.settings-tab[data-tab="${A}"]`),J=document.getElementById(`settings-tab-${A}`);H&&J?(H.classList.add("active"),J.classList.add("active")):C[0]&&T[0]&&(C[0].classList.add("active"),T[0].classList.add("active"));const w=u.querySelectorAll(".settings-group"),$=u.querySelectorAll(".setting-item");w.forEach(L=>L.style.display=""),$.forEach(L=>L.style.display="");return}T.forEach(A=>{A.classList.add("active")}),C.forEach(A=>{A.classList.remove("active")}),u.querySelectorAll(".settings-group").forEach(A=>{const H=A.querySelectorAll(".setting-item");let J=!1;H.forEach(w=>{const $=w.querySelector(".label"),L=w.querySelector(".description"),_=$?.textContent?.toLowerCase()||"",K=L?.textContent?.toLowerCase()||"";_.includes(l)||K.includes(l)?(w.style.display="",J=!0):w.style.display="none"}),A.style.display=J?"":"none"})}function sa(){const l=document.getElementById("manage-blocked-btn"),u=document.getElementById("clear-all-blocked-btn"),T=document.getElementById("blocked-content-list"),C=document.getElementById("blocked-artists-list"),le=document.getElementById("blocked-albums-list"),A=document.getElementById("blocked-tracks-list"),H=document.getElementById("blocked-artists-section"),J=document.getElementById("blocked-albums-section"),w=document.getElementById("blocked-tracks-section"),$=document.getElementById("blocked-empty-message");if(!l||!T)return;function L(){const _=he.getBlockedArtists(),K=he.getBlockedAlbums(),F=he.getBlockedTracks(),I=_.length+K.length+F.length;l.textContent=I>0?`Manage (${I})`:"Manage",u&&(u.style.display=I>0?"inline-block":"none"),H.style.display=_.length>0?"block":"none",J.style.display=K.length>0?"block":"none",w.style.display=F.length>0?"block":"none",$.style.display=I===0?"block":"none",C&&(C.innerHTML=_.map(y=>`
                <li data-id="${y.id}" data-type="artist">
                    <div class="item-info">
                        <div class="item-name">${Ze(y.name)}</div>
                        <div class="item-meta">${new Date(y.blockedAt).toLocaleDateString()}</div>
                    </div>
                    <button class="unblock-btn" data-id="${y.id}" data-type="artist">Unblock</button>
                </li>
            `).join("")),le&&(le.innerHTML=K.map(y=>`
                <li data-id="${y.id}" data-type="album">
                    <div class="item-info">
                        <div class="item-name">${Ze(y.title)}</div>
                        <div class="item-meta">${Ze(y.artist||"Unknown Artist")}  ${new Date(y.blockedAt).toLocaleDateString()}</div>
                    </div>
                    <button class="unblock-btn" data-id="${y.id}" data-type="album">Unblock</button>
                </li>
            `).join("")),A&&(A.innerHTML=F.map(y=>`
                <li data-id="${y.id}" data-type="track">
                    <div class="item-info">
                        <div class="item-name">${Ze(y.title)}</div>
                        <div class="item-meta">${Ze(y.artist||"Unknown Artist")}  ${new Date(y.blockedAt).toLocaleDateString()}</div>
                    </div>
                    <button class="unblock-btn" data-id="${y.id}" data-type="track">Unblock</button>
                </li>
            `).join("")),T.querySelectorAll(".unblock-btn").forEach(y=>{y.addEventListener("click",D=>{D.stopPropagation();const M=y.dataset.id,ee=y.dataset.type;ee==="artist"?he.unblockArtist(M):ee==="album"?he.unblockAlbum(M):ee==="track"&&he.unblockTrack(M),L()})})}l.addEventListener("click",()=>{const _=T.style.display!=="none";T.style.display=_?"none":"block",_||L()}),u&&u.addEventListener("click",()=>{confirm("Are you sure you want to unblock all artists, albums, and tracks?")&&(he.clearAllBlocked(),L())}),L()}function Ze(l){if(!l)return"";const u=document.createElement("div");return u.textContent=l,u.innerHTML}export{ca as initializeSettings};
